{% extends 'parent/base.html' %}
{% block title %}Post List{% endblock title %}

{% block content %}
<h1>Post List</h1>
<br>

{% if tag %}
    <h2>Posts tagged with "{{ tag.name }}"</h2>
{% endif %}

<!-- Posts Container -->
<ul id="post-container">
    {% for post in posts %}
        <li class="post-item post" data-post-id="{{ post.id }}" id="post-{{ post.id }}">
            <a href="{% url 'social:post_detail' post.id %}">{{ post.title }}</a>

            <p>{{ post.content }}</p>
            <p>Author: {{ post.author.username }}</p>
            <p>Created at: {{ post.created }}</p>
            <p>Updated at: {{ post.updated }}</p>

            <p>Tags:
                {% for tag in post.tags.all %}
                    <a href="{% url 'social:post-list-by-tag' tag.slug %}">{{ tag.name }}</a>{% if not forloop.last %}, {% endif %}
                {% empty %}
                    No tags
                {% endfor %}
            </p>

            <button class="like-button">
                {% if user in post.likes.all %}Unlike{% else %}Like{% endif %}
            </button>
            <span class="likes-count">{{ post.likes.count }}</span> Likes

            <button class="save-button">
                {% if user in post.save_by.all %}Unsave{% else %}Save{% endif %}
            </button>
        </li>
    {% empty %}
        <li>No posts available.</li>
    {% endfor %}
</ul>

<!-- Load More Button -->
{% if posts.has_next %}
    <button id="load-more" data-next-page="{{ posts.next_page_number }}">
        Load more
    </button>
{% endif %}

<!-- CSRF token -->
<meta name="csrf-token" content="{{ csrf_token }}">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script>
$(document).ready(function () {
    const csrfToken = $('meta[name="csrf-token"]').attr('content');

    // LIKE button using event delegation
    $(document).on('click', '.like-button', function () {
        const postDiv = $(this).closest('.post');
        const post_id = postDiv.data('post-id');
        const button = $(this);
        const likesCount = postDiv.find('.likes-count');

        $.ajax({
            type: "POST",
            url: "{% url 'social:like_post' %}",
            data: {
                post_id: post_id,
                csrfmiddlewaretoken: csrfToken
            },
            success: function (data) {
                button.text(data.liked ? "Unlike" : "Like");
                likesCount.text(data.post_like_count);
            },
            error: function () {
                alert("Something went wrong!");
            }
        });
    });

    // SAVE button using event delegation
    $(document).on('click', '.save-button', function () {
        const postDiv = $(this).closest('.post');
        const post_id = postDiv.data('post-id');
        const button = $(this);

        $.ajax({
            type: "POST",
            url: "{% url 'social:save_post' %}",
            data: {
                post_id: post_id,
                csrfmiddlewaretoken: csrfToken
            },
            success: function (data) {
                button.text(data.saved ? "Unsave" : "Save");
            },
            error: function () {
                alert("Error saving post!");
            }
        });
    });

    // Load more posts
    $('#load-more').click(function () {
        const loadMoreBtn = $(this);
        const nextPage = loadMoreBtn.data('next-page');

        fetch(`?page=${nextPage}`, {
            headers: {"x-requested-with": "XMLHttpRequest"}
        })
        .then(response => response.text())
        .then(data => {
            $('#post-container').append(data);

            const newNextPage = parseInt(nextPage) + 1;
            if (newNextPage > {{ posts.paginator.num_pages }}) {
                loadMoreBtn.remove();
            } else {
                loadMoreBtn.data('next-page', newNextPage);
            }
        })
        .catch(error => console.error("Error:", error));
    });
});
</script>

{% endblock content %}
